FROM quay.io/fedora-asahi-remix-atomic-desktops/silverblue:42

# Enforce pipefail
# SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# 1. Setup Build Context
COPY config /tmp/config

# 2. Apply System Files (Overlay)
RUN cp -a /tmp/config/files/usr/. /usr/ && \
    cp -a /tmp/config/files/etc/. /etc/

# 3. Install Config Data (Standardized Path)
RUN mkdir -p /usr/share/asahi-atomic && \
    cp /tmp/config/flatpaks.txt /usr/share/asahi-atomic/ && \
    cp /tmp/config/distrobox.ini /usr/share/asahi-atomic/

# 4. Execute Build Module
RUN chmod +x /tmp/config/modules/build.sh && \
    /tmp/config/modules/build.sh && \
    rpm-ostree cleanup -m

# 5. Cleanup
RUN rm -rf /tmp/* /var/tmp/*
